pr: none

trigger:
- master

pool: GCP2

variables:
- group: SONATYPE_VAR_GROUP
- group: PGP_VAR_GROUP
- group: SYSTEM_VAR_GROUP
- name: PGP_PASSPHRASE

steps:
  # We need a valid signing key. 
  # The next two steps download the public and private keys from the
  # secure library files. 
  - task: DownloadSecureFile@1
    displayName: 'Download public key.'
    inputs:
      secureFile: public.pgp
  - task: DownloadSecureFile@1
    displayName: 'Download private key.'
    inputs:
      secureFile: private.pgp

  # Import both the private and public keys into gpg for signing.
  - bash: |
      gpg --import --no-tty --batch --yes $(Agent.TempDirectory)/public.pgp
      gpg --import --no-tty --batch --yes $(Agent.TempDirectory)/private.pgp
      gpg --list-keys --keyid-format LONG
      gpg --list-secret-keys --keyid-format LONG
    displayName: 'Import signing keys.'

  # Set PGP PASSPHARSE as Environment Variable
  - bash: |
      echo "Setting PGP passphrase as environment variable..."
    displayName: 'Setting PGP passphrase as environment variable'
    env:
      PGP_PASSPHRASE: $(PGP_PASSPHRASE) # map PGP passphrase to an env variable

  # Install Java 11
  - task: adopt-openjdk-installer@1
    inputs:
      majorVersion: '11'
      useLatestOption: 'latest'
      jdkArchitectureOption: 'x64'
      jvmOption: 'hotspot'

  # Setup SBT first for the master pipeline build
  - task: setup-sbt@1
    displayName: 'Setup SBT for pipeline'
    inputs:
      sbtVersion: '1.5.1'
    
  # Set the Sonatype credentials for SBT
  - script: |
      sbt 'set credentials += Credentials("Sonatype Nexus Repository Manager", "oss.sonatype.org","$(SONATYPE_USER)","$(SONATYPE_PASS)")'
    displayName: 'sbt set sonatype credentials'

  # Set the PGP credentials for SBT
  - script: |
      sbt 'set credentials += Credentials("GnuPG Key ID", "gpg", "$(PGP_KEYNAME)","$(PGP_PASSPHRASE)")'
      sbt 'set envVars := Map("PGP_PASSPHRASE" -> "$(PGP_PASSPHRASE)")'
      sbt 'set envVars := Map("pgpPassphrase" -> "$(PGP_PASSPHRASE)")'
    displayName: 'sbt set gpg credentials'

  # Compile the project
  - script: |
      sbt compile
    displayName: 'sbt compile'

  # Run the tests
  - script: |
      sbt test
    displayName: 'sbt test'

  # Test GPG Installation
  - script: |
      gpg --version
    displayName: 'debug gpg installation'

  # Run the tests
  - script: |
      sbt publishSigned
    displayName: 'sbt signed deploy to sonatype'